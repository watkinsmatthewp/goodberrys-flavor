'use strict';

process.env.DEBUG = 'actions-on-google:*';
const App = require('actions-on-google').DialogflowApp;
const functions = require('firebase-functions');

const NAME_ACTION = 'get_flavor';
const DATE_ARGUMENT = 'date';

const CLOSED_FLAVOR = 'CLOSED';
const FLAVORS = {
  '2017-12-01': 'Sweet Cream',
  '2017-12-02': 'Jamocha',
  '2017-12-03': 'Strawberry',
  '2017-12-04': 'Peanut Butter',
  '2017-12-05': 'Blackberry',
  '2017-12-06': 'Pistachio',
  '2017-12-07': 'Pralines & Cream',
  '2017-12-08': 'Peppermint',
  '2017-12-09': 'Nutella',
  '2017-12-10': 'Pumpkin',
  '2017-12-11': 'Chocolate Malt',
  '2017-12-12': 'Burgundy Cherry',
  '2017-12-13': 'Raspberry',
  '2017-12-14': 'Butter Pecan',
  '2017-12-15': 'Mint Chocolate Chip',
  '2017-12-16': 'Creme Brulee',
  '2017-12-17': 'Nutella',
  '2017-12-18': 'Strawberry',
  '2017-12-19': 'Chocolate Chip Cookie Dough',
  '2017-12-20': 'Cinnamon Chocolate Chip',
  '2017-12-21': 'Cheesecake',
  '2017-12-22': 'Rum Raisin',
  '2017-12-23': 'Peppermint',
  '2017-12-24': 'Mint Chocolate Chip',
  '2017-12-25': CLOSED_FLAVOR,
  '2017-12-26': 'Jamocha',
  '2017-12-27': 'Chocolate Malt',
  '2017-12-28': 'Peanut Butter',
  '2017-12-29': 'Butter Pecan',
  '2017-12-30': 'Salted Caramel',
  '2017-12-31': 'Eggnog',
  '2018-01-01': 'Sweet Cream',
  '2018-01-02': 'Creme Brulee',
  '2018-01-03': 'Strawberry',
  '2018-01-04': 'Chocolate Malt',
  '2018-01-05': 'Chocolate Chip Cookie Dough',
  '2018-01-06': 'Peppermint',
  '2018-01-07': 'Nutella',
  '2018-01-08': 'Burgundy Cherry',
  '2018-01-09': 'Jamocha',
  '2018-01-10': 'Salted Caramel',
  '2018-01-11': 'Blackberry',
  '2018-01-12': 'Mint Chocolate Chip',
  '2018-01-13': 'Butter Pecan',
  '2018-01-14': 'Peanut Butter',
  '2018-01-15': 'Peppermint',
  '2018-01-16': 'Raspberry',
  '2018-01-17': 'Chocolate Chip Cookie Dough',
  '2018-01-18': 'Pistachio',
  '2018-01-19': 'Pralines & Cream',
  '2018-01-20': 'Sweet Cream',
  '2018-01-21': 'Mint Chocolate Chip',
  '2018-01-22': 'Chocolate Malt',
  '2018-01-23': 'Burgundy Cherry',
  '2018-01-24': 'Cinnamon Chocolate Chip',
  '2018-01-25': 'Butter Pecan',
  '2018-01-26': 'Jamocha',
  '2018-01-27': 'Salted Caramel',
  '2018-01-28': 'Strawberry',
  '2018-01-29': 'Cheesecake',
  '2018-01-30': 'Nutella',
  '2018-01-31': 'Peanut Butter',
  '2018-02-01': 'Sweet Cream',
  '2018-02-02': 'Chocolate Chip Cookie Dough',
  '2018-02-03': 'Mint Chocolate Chip',
  '2018-02-04': 'Burgundy Cherry',
  '2018-02-05': 'Chocolate Malt',
  '2018-02-06': 'Blackberry',
  '2018-02-07': 'Cheesecake',
  '2018-02-08': 'Raspberry',
  '2018-02-09': 'Butter Pecan',
  '2018-02-10': 'Jamocha',
  '2018-02-11': 'Banana Pudding',
  '2018-02-12': 'Pralines & Cream',
  '2018-02-13': 'Cinnamon Chocolate Chip',
  '2018-02-14': 'Strawberry',
  '2018-02-15': 'Peanut Butter',
  '2018-02-16': 'Pistachio',
  '2018-02-17': 'Nutella',
  '2018-02-18': 'Mint Chocolate Chip',
  '2018-02-19': 'Butter Pecan',
  '2018-02-10': 'Sweet Cream',
  '2018-02-21': 'Burgundy Cherry',
  '2018-02-22': 'Jamocha',
  '2018-02-23': 'Chocolate Malt',
  '2018-02-24': 'Salted Caramel',
  '2018-02-25': 'Chocolate Chip Cookie Dough',
  '2018-02-26': 'Peanut Butter',
  '2018-02-27': 'Banana Pudding',
  '2018-02-28': 'Coconut',
  '2018-03-01': 'Sweet Cream',
  '2018-03-02': 'Strawberry',
  '2018-03-03': 'Chocolate Malt',
  '2018-03-04': 'Butter Pecan',
  '2018-03-05': 'Jamocha',
  '2018-03-06': 'Blackberry',
  '2018-03-07': 'Chocolate Chip Cookie Dough',
  '2018-03-08': 'Nutella',
  '2018-03-09': 'Pistachio',
  '2018-03-10': 'Burgundy Cherry',
  '2018-03-11': 'Peanut Butter',
  '2018-03-12': 'Coconut',
  '2018-03-13': 'Sweet Cream',
  '2018-03-14': 'Raspberry',
  '2018-03-15': 'Banana Pudding',
  '2018-03-16': 'Cheesecake',
  '2018-03-17': 'Mint Chocolate Chip',
  '2018-03-18': 'Pralines & Cream',
  '2018-03-19': 'Chocolate Malt',
  '2018-03-20': 'Strawberry',
  '2018-03-21': 'Butter Pecan',
  '2018-03-22': 'Salted Caramel',
  '2018-03-23': 'Chocolate Chip Cookie Dough',
  '2018-03-24': 'Pistachio',
  '2018-03-25': 'Mint Chocolate Chip',
  '2018-03-26': 'Burgundy Cherry',
  '2018-03-27': 'Jamocha',
  '2018-03-28': 'Peanut Butter',
  '2018-03-29': 'Pina Colada',
  '2018-03-30': 'Nutella',
  '2018-03-31': 'Banana Pudding',
  '2018-04-01': 'Mint Chocolate Chip',
  '2018-04-02': 'Chocolate Malt',
  '2018-04-03': 'Jamocha',
  '2018-04-04': 'Butter Pecan',
  '2018-04-05': 'Pistachio',
  '2018-04-06': 'Sweet Cream',
  '2018-04-07': 'Strawberry',
  '2018-04-08': 'Cheesecake',
  '2018-04-09': 'Raspberry',
  '2018-04-10': 'Peanut Butter',
  '2018-04-11': 'Mint Chocolatem Chip',
  '2018-04-12': 'Nutella',
  '2018-04-13': 'Chocolate Chip Cookie Dough',
  '2018-04-14': 'Banana Pudding',
  '2018-04-15': 'Coconut',
  '2018-04-16': 'Butter Pecan',
  '2018-04-17': 'Mint Chocolate Chip',
  '2018-04-18': 'Strawberry',
  '2018-04-19': 'Chocolate Malt',
  '2018-04-20': 'Salted Caramel',
  '2018-04-21': 'Pistachio',
  '2018-04-22': 'Peanut Butter',
  '2018-04-23': 'Jamocha',
  '2018-04-24': 'Nutella',
  '2018-04-25': 'Banana Pudding',
  '2018-04-26': 'Blackberry',
  '2018-04-27': 'Burgundy Cherry',
  '2018-04-28': 'Pina Colada',
  '2018-04-29': 'Peach',
  '2018-04-30': 'Coconut',
  '2018-05-01': 'Sweet Cream',
  '2018-05-02': 'Butter Pecan',
  '2018-05-03': 'Raspberry',
  '2018-05-04': 'Pistachio',
  '2018-05-05': 'Pina Colada',
  '2018-05-06': 'Chocolate Match',
  '2018-05-07': 'Mint Chocolate Chip',
  '2018-05-08': 'Peanut Butter',
  '2018-05-09': 'Jamocha',
  '2018-05-10': 'Burgundy Cherry',
  '2018-05-11': 'Nutella',
  '2018-05-12': 'Coconut',
  '2018-05-13': 'Strawberry',
  '2018-05-14': 'Cheesecake',
  '2018-05-15': 'Banana Pudding',
  '2018-05-16': 'Salted Caramel',
  '2018-05-17': 'Sweet Cream',
  '2018-05-18': 'Blueberry',
  '2018-05-19': 'Peach',
  '2018-05-20': 'Peanut Butter',
  '2018-05-21': 'Pistachio',
  '2018-05-22': 'Chocolate Malt',
  '2018-05-23': 'Strawberry',
  '2018-05-24': 'Coconut',
  '2018-05-25': 'Jamocha',
  '2018-05-26': 'Mint Chocolate Chip',
  '2018-05-27': 'Butter Pecan',
  '2018-05-28': 'Banana Pudding',
  '2018-05-29': 'Blackberry',
  '2018-05-30': 'Burgundy Cherry',
  '2018-05-31': 'Lemon',
  '2018-06-01': 'Sweet Cream',
  '2018-06-02': 'Mint Chocolate Chip',
  '2018-06-03': 'Chocolate Malt',
  '2018-06-04': 'Burgundy Cherry',
  '2018-06-05': 'Pina Colada',
  '2018-06-06': 'Butter Pecan',
  '2018-06-07': 'Pistachio',
  '2018-06-08': 'Blueberry',
  '2018-06-09': 'Peanut Butter',
  '2018-06-10': 'Strawberry',
  '2018-06-11': 'Jamocha',
  '2018-06-12': 'Banana Pudding',
  '2018-06-13': 'Peach',
  '2018-06-14': 'Nutella',
  '2018-06-15': 'Chocolate Chip Cookie Dough',
  '2018-06-16': 'Coconut',
  '2018-06-17': 'Butter Pecan',
  '2018-06-18': 'Chocolate Malt',
  '2018-06-19': 'Salted Caramel',
  '2018-06-20': 'Pistachio',
  '2018-06-21': 'Lemon',
  '2018-06-22': 'Raspberry',
  '2018-06-23': 'Burgundy Cherry',
  '2018-06-24': 'Chocolate Chip Cookie Dough',
  '2018-06-25': 'Mint Chocolate Chip',
  '2018-06-26': 'Peanut Butter',
  '2018-06-27': 'Coconut',
  '2018-06-28': 'Strawberry',
  '2018-06-29': 'Jamocha',
  '2018-06-30': 'Banana Pudding',
  '2018-07-01': 'Sweet Cream',
  '2018-07-02': 'Pistachio',
  '2018-07-03': 'Chocolate Malt',
  '2018-07-04': 'Blueberry',
  '2018-07-05': 'Butter Pecan',
  '2018-07-06': 'Burgundy Cherry',
  '2018-07-07': 'Nutella',
  '2018-07-08': 'Banana Pudding',
  '2018-07-09': 'Coconut',
  '2018-07-10': 'Jamocha',
  '2018-07-11': 'Chocolate Chip Cookie Dough',
  '2018-07-12': 'Strawberry',
  '2018-07-13': 'Mint Chocolate Chip',
  '2018-07-14': 'Birthday Cake',
  '2018-07-15': 'Salted Caramel',
  '2018-07-16': 'Raspberry',
  '2018-07-17': 'Lemon',
  '2018-07-18': 'Pina Colada',
  '2018-07-19': 'Cheesecake',
  '2018-07-20': 'Peanut Butter',
  '2018-07-21': 'Peach',
  '2018-07-22': 'Butter Pecan',
  '2018-07-23': 'Jamocha',
  '2018-07-24': 'Strawberry',
  '2018-07-25': 'Birthday Cake',
  '2018-07-26': 'Chocolate Malt',
  '2018-07-27': 'Coconut',
  '2018-07-28': 'Chocolate Chip Cookie Dough',
  '2018-07-29': 'Mint Chocolate Chip',
  '2018-07-30': 'Banana Pudding',
  '2018-07-31': 'Peanut Butter',
  '2018-08-01': 'Sweet Cream',
  '2018-08-02': 'Pistachio',
  '2018-08-03': 'Jamocha',
  '2018-08-04': 'Chocolate Chip Cookie Dough',
  '2018-08-05': 'Peach',
  '2018-08-06': 'Salted Caramel',
  '2018-08-07': 'Strawberry',
  '2018-08-08': 'Chocolate Malt',
  '2018-08-09': 'Lemon',
  '2018-08-10': 'Coconut',
  '2018-08-11': 'Birthday Cake',
  '2018-08-12': 'Mint Chocolate Chip',
  '2018-08-13': 'Raspberry',
  '2018-08-14': 'Peanut Butter',
  '2018-08-15': 'Burgundy Cherry',
  '2018-08-16': 'Blueberry',
  '2018-08-17': 'Banana Pudding',
  '2018-08-18': 'Butter Pecan',
  '2018-08-19': 'Pistachio',
  '2018-08-20': 'Chocolate Chip Cookie Dough',
  '2018-08-21': 'Birthday Cake',
  '2018-08-22': 'Jamocha',
  '2018-08-23': 'Nutella',
  '2018-08-24': 'Strawberry',
  '2018-08-25': 'Peanut Butter',
  '2018-08-26': 'Coconut',
  '2018-08-27': 'Cheesecake',
  '2018-08-28': 'Burgundy Cherry',
  '2018-08-29': 'Butter Pecan',
  '2018-08-30': 'Mint Chocolate Chip',
  '2018-08-31': 'Chocolate Malt',
  '2018-09-01': 'Unknown',
  '2018-09-02': 'Unknown',
  '2018-09-03': 'Unknown',
  '2018-09-04': 'Unknown',
  '2018-09-05': 'Unknown',
  '2018-09-06': 'Unknown',
  '2018-09-07': 'Unknown',
  '2018-09-08': 'Unknown',
  '2018-09-09': 'Unknown',
  '2018-09-10': 'Unknown',
  '2018-09-11': 'Unknown',
  '2018-09-12': 'Unknown',
  '2018-09-13': 'Unknown',
  '2018-09-14': 'Unknown',
  '2018-09-15': 'Unknown',
  '2018-09-16': 'Unknown',
  '2018-09-17': 'Unknown',
  '2018-09-18': 'Unknown',
  '2018-09-19': 'Unknown',
  '2018-09-20': 'Unknown',
  '2018-09-21': 'Unknown',
  '2018-09-22': 'Unknown',
  '2018-09-23': 'Unknown',
  '2018-09-24': 'Unknown',
  '2018-09-25': 'Unknown',
  '2018-09-26': 'Unknown',
  '2018-09-27': 'Unknown',
  '2018-09-28': 'Unknown',
  '2018-09-29': 'Unknown',
  '2018-09-30': 'Unknown',
  '2018-10-01': 'Sweet Cream',
  '2018-10-02': 'Salted Caramel',
  '2018-10-03': 'Pistachio',
  '2018-10-04': 'Coconut',
  '2018-10-05': 'Chocolate Malt',
  '2018-10-06': 'Mint Chocolate Chip',
  '2018-10-07': 'Butter Pecan',
  '2018-10-08': 'Burgundy Cherry',
  '2018-10-09': 'Strawberry',
  '2018-10-10': 'Pumpkin',
  '2018-10-11': 'Jamocha',
  '2018-10-12': 'Peanut Butter',
  '2018-10-13': 'Chocolate Chip Cookie Dough',
  '2018-10-14': 'Nutella',
  '2018-10-15': 'Pistachio',
  '2018-10-16': 'Mint Chocolate Chip',
  '2018-10-17': 'Birthday Cake',
  '2018-10-18': 'Maple Almond',
  '2018-10-19': 'Salted Caramel',
  '2018-10-20': 'Pumpkin',
  '2018-10-21': 'Jamocha',
  '2018-10-22': 'Cheesecake',
  '2018-10-23': 'Chocolate Chip Cookie Dough',
  '2018-10-24': 'Burgundy Cherry',
  '2018-10-25': 'Peanut Butter',
  '2018-10-26': 'Pumpkin',
  '2018-10-27': 'Strawberry',
  '2018-10-28': 'Mint Chocolate Chip',
  '2018-10-29': 'Chocolate Malt',
  '2018-10-30': 'Butter Pecan',
  '2018-10-31': 'Pumpkin',
  '2018-11-01': 'Unknown',
  '2018-11-02': 'Unknown',
  '2018-11-03': 'Unknown',
  '2018-11-04': 'Unknown',
  '2018-11-05': 'Unknown',
  '2018-11-06': 'Unknown',
  '2018-11-07': 'Unknown',
  '2018-11-08': 'Unknown',
  '2018-11-09': 'Unknown',
  '2018-11-10': 'Unknown',
  '2018-11-11': 'Unknown',
  '2018-11-12': 'Unknown',
  '2018-11-13': 'Unknown',
  '2018-11-14': 'Unknown',
  '2018-11-15': 'Unknown',
  '2018-11-16': 'Unknown',
  '2018-11-17': 'Unknown',
  '2018-11-18': 'Unknown',
  '2018-11-19': 'Unknown',
  '2018-11-20': 'Unknown',
  '2018-11-21': 'Unknown',
  '2018-11-22': 'Unknown',
  '2018-11-23': 'Unknown',
  '2018-11-24': 'Unknown',
  '2018-11-25': 'Unknown',
  '2018-11-26': 'Unknown',
  '2018-11-27': 'Unknown',
  '2018-11-28': 'Unknown',
  '2018-11-29': 'Unknown',
  '2018-11-30': 'Unknown',
  '2018-12-01': 'Unknown',
  '2018-12-02': 'Unknown',
  '2018-12-03': 'Unknown',
  '2018-12-04': 'Unknown',
  '2018-12-05': 'Unknown',
  '2018-12-06': 'Unknown',
  '2018-12-07': 'Unknown',
  '2018-12-08': 'Unknown',
  '2018-12-09': 'Unknown',
  '2018-12-10': 'Unknown',
  '2018-12-11': 'Unknown',
  '2018-12-12': 'Unknown',
  '2018-12-13': 'Unknown',
  '2018-12-14': 'Unknown',
  '2018-12-15': 'Unknown',
  '2018-12-16': 'Unknown',
  '2018-12-17': 'Unknown',
  '2018-12-18': 'Unknown',
  '2018-12-19': 'Unknown',
  '2018-12-20': 'Unknown',
  '2018-12-21': 'Unknown',
  '2018-12-22': 'Unknown',
  '2018-12-23': 'Unknown',
  '2018-12-24': 'Unknown',
  '2018-12-25': 'Unknown',
  '2018-12-26': 'Unknown',
  '2018-12-27': 'Unknown',
  '2018-12-28': 'Unknown',
  '2018-12-29': 'Unknown',
  '2018-12-30': 'Unknown',
  '2018-12-31': 'Unknown'
};

const GOODBYE = '. If there\'s anything else you need, just summon me again by telling your Google Assistant to "talk to Goodberry\'s Flavor."'

Date.prototype.addHours = function(h) {    
   this.setTime(this.getTime() + (h*60*60*1000)); 
   return this;   
}

Date.prototype.toStandardString = function() {
  return (
    this.getFullYear() + '-' +
    ('00' + (this.getMonth() + 1)).slice(-2) + '-' +
    ('00' + this.getDate()).slice(-2)
  );
}


exports.getFlavor = functions.https.onRequest((request, response) => {
  const app = new App({request, response});
  console.log('Request headers: ' + JSON.stringify(request.headers));
  console.log('Request body: ' + JSON.stringify(request.body));

  function getFlavor (app) {
    let todayDateStr = new Date().addHours(-5).toStandardString(); // EST
    let dateStr = app.getArgument(DATE_ARGUMENT) || todayDateStr;
    console.log('User wants to know the flavor of the day for ' + dateStr);
    let flavor = FLAVORS[dateStr];
    console.log(flavor);
    
    let relativeDateToSay = dateStr === todayDateStr ? 'today' : 'on that day';
    if (flavor && flavor !== 'Unknown') {
      if (flavor === CLOSED_FLAVOR) {
        app.tell('Actually, Goodberry\'s is closed ' + relativeDateToSay + GOODBYE);
      } else {
        app.tell('The flavor of the day ' + relativeDateToSay + ' is ' + flavor + GOODBYE);
      }
    } else {
      app.tell('Sorry, I don\'t have information for ' + relativeDateToSay + GOODBYE);
    }
  }

  let actionMap = new Map();
  actionMap.set(NAME_ACTION, getFlavor);
  
  app.handleRequest(actionMap);
});
